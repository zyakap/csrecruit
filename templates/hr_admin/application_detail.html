{% extends 'hr_admin/base.html' %}
{% block title %}Application #{{ application.pk }} - HR Admin{% endblock %}
{% block hr_content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="fw-bold mb-0"><i class="bi bi-person-lines-fill me-2"></i>{{ application.full_name }}</h4>
    <a href="{% url 'hr_admin:application_list' %}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left me-1"></i>Back
    </a>
</div>

<div class="row g-3">
    <div class="col-md-8">
        <!-- Application Info -->
        <div class="card mb-3">
            <div class="card-header bg-pngcs text-white">
                Application #{{ application.pk }} — {{ application.vacancy.title }}
                <small class="ms-2 opacity-75">Ref: {{ application.vacancy.reference_number }}</small>
            </div>
            <div class="card-body">
                <div class="row small">
                    <div class="col-md-6">
                        <h6 class="fw-bold text-muted text-uppercase small">Personal</h6>
                        <p class="mb-1"><strong>Name:</strong> {{ application.full_name }}</p>
                        <p class="mb-1"><strong>DOB:</strong> {{ application.date_of_birth|date:"d M Y" }} (Age {{ application.get_age }})</p>
                        <p class="mb-1"><strong>Gender:</strong> {{ application.gender }}</p>
                        <p class="mb-1"><strong>Province:</strong> {{ application.province }}</p>
                        <p class="mb-1"><strong>Phone:</strong> {{ application.phone }}</p>
                        <p class="mb-1"><strong>Email:</strong> {{ application.email }}</p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="fw-bold text-muted text-uppercase small">Education</h6>
                        <p class="mb-1"><strong>Qualification:</strong> {{ application.get_highest_qualification_display }}</p>
                        <p class="mb-1"><strong>Institution:</strong> {{ application.institution }}</p>
                        <p class="mb-1"><strong>Year:</strong> {{ application.year_completed }}</p>
                        <p class="mb-1"><strong>Grade/Result:</strong> {{ application.grade_result }}</p>
                        <p class="mb-1"><strong>Experience:</strong> {{ application.years_experience }} year(s)</p>
                        {% if application.current_employer %}
                        <p class="mb-1"><strong>Current:</strong> {{ application.current_position }} @ {{ application.current_employer }}</p>
                        {% endif %}
                    </div>
                </div>
                {% if application.work_history %}
                <h6 class="fw-bold text-muted text-uppercase small mt-3">Work History</h6>
                <p class="small">{{ application.work_history }}</p>
                {% endif %}
                {% if application.cover_letter %}
                <h6 class="fw-bold text-muted text-uppercase small mt-3">Cover Letter</h6>
                <p class="small bg-light p-2 rounded">{{ application.cover_letter }}</p>
                {% endif %}
                {% if application.ai_summary %}
                <div class="alert alert-info mt-3 small">
                    <i class="bi bi-robot me-2"></i><strong>AI Summary:</strong> {{ application.ai_summary }}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Documents -->
        <div class="card mb-3">
            <div class="card-header bg-white border-bottom"><h6 class="mb-0 fw-bold"><i class="bi bi-paperclip me-2"></i>Documents</h6></div>
            <div class="card-body p-0">
                {% for doc in documents %}
                <div class="border-bottom px-3 py-2 d-flex justify-content-between align-items-center">
                    <div>
                        <i class="bi bi-file-earmark me-2"></i>
                        <strong class="small">{{ doc.get_doc_type_display }}</strong>
                        <small class="text-muted ms-2">{{ doc.filename }}</small>
                    </div>
                    <div class="d-flex gap-2 align-items-center">
                        {% if doc.verified %}
                            <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Verified</span>
                        {% else %}
                            <form method="post" class="d-inline">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="verify_doc">
                                <input type="hidden" name="doc_id" value="{{ doc.pk }}">
                                <button type="submit" class="btn btn-outline-success btn-sm">Verify</button>
                            </form>
                        {% endif %}
                        <a href="{{ doc.file.url }}" target="_blank" class="btn btn-outline-secondary btn-sm"><i class="bi bi-download"></i></a>
                    </div>
                </div>
                {% empty %}
                <p class="text-muted small p-3 mb-0">No documents uploaded.</p>
                {% endfor %}
            </div>
        </div>

        <!-- Interviews -->
        {% if interviews %}
        <div class="card mb-3">
            <div class="card-header bg-white border-bottom"><h6 class="mb-0 fw-bold"><i class="bi bi-camera-video me-2"></i>Interviews</h6></div>
            <div class="card-body">
                {% for interview in interviews %}
                <div class="border rounded p-3 mb-2">
                    <div class="d-flex justify-content-between">
                        <div>
                            <strong>{{ interview.scheduled_date|date:"l, d F Y" }}</strong> at {{ interview.scheduled_date|time:"H:i" }}<br>
                            <small class="text-muted">Venue: {{ interview.venue }}</small><br>
                            <small>Panel: {% for m in interview.panel_members.all %}{{ m.get_full_name }}{% if not forloop.last %}, {% endif %}{% endfor %}</small>
                        </div>
                        <div>
                            <span class="badge bg-{{ interview.status }}">{{ interview.get_status_display }}</span>
                            {% with avg=interview.average_panel_score %}
                            {% if avg %}<span class="badge bg-success ms-1">Score: {{ avg }}/100</span>{% endif %}
                            {% endwith %}
                        </div>
                    </div>
                    {% for pscore in interview.panel_scores.all %}
                    <div class="mt-2 small text-muted border-top pt-2">
                        <i class="bi bi-person-check me-1"></i>{{ pscore.panel_member.get_full_name }}: {{ pscore.score }}/100
                        {% if pscore.recommendation %} — {{ pscore.get_recommendation_display }}{% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Right Panel -->
    <div class="col-md-4">
        <!-- Score Card -->
        <div class="card mb-3">
            <div class="card-header bg-white border-bottom"><h6 class="mb-0 fw-bold"><i class="bi bi-star me-2"></i>AI Score</h6></div>
            <div class="card-body text-center">
                {% if application.total_score %}
                <div class="display-4 fw-bold {% if application.total_score >= 70 %}text-success{% elif application.total_score >= 50 %}text-warning{% else %}text-danger{% endif %}">
                    {{ application.total_score }}
                </div>
                <p class="text-muted small">out of 100</p>
                {% else %}
                <p class="text-muted">Not yet scored</p>
                {% endif %}
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="rescore">
                    <button type="submit" class="btn btn-outline-info btn-sm w-100 mb-2">
                        <i class="bi bi-robot me-1"></i>Re-run AI Score
                    </button>
                </form>
                <a href="{% url 'hr_admin:interview_schedule' application.pk %}" class="btn btn-outline-primary btn-sm w-100">
                    <i class="bi bi-calendar-plus me-1"></i>Schedule Interview
                </a>
            </div>
        </div>

        <!-- Update Status -->
        <div class="card mb-3">
            <div class="card-header bg-white border-bottom"><h6 class="mb-0 fw-bold"><i class="bi bi-arrow-repeat me-2"></i>Update Status</h6></div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="update_status">
                    <div class="mb-2">
                        <select name="status" class="form-select form-select-sm">
                            {% for val, label in statuses %}
                            <option value="{{ val }}" {% if application.status == val %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-2">
                        <textarea name="hr_notes" class="form-control form-control-sm" rows="2"
                                  placeholder="HR notes (optional)...">{{ application.hr_notes }}</textarea>
                    </div>
                    <button type="submit" class="btn btn-pngcs btn-sm w-100">Update & Notify Applicant</button>
                </form>
            </div>
        </div>

        <!-- References -->
        <div class="card">
            <div class="card-header bg-white border-bottom"><h6 class="mb-0 fw-bold"><i class="bi bi-people me-2"></i>References</h6></div>
            <div class="card-body small">
                <p class="mb-1"><strong>{{ application.reference1_name }}</strong></p>
                <p class="mb-1 text-muted">{{ application.reference1_position }}</p>
                <p class="mb-2">{{ application.reference1_phone }}</p>
                {% if application.reference2_name %}
                <p class="mb-1"><strong>{{ application.reference2_name }}</strong></p>
                <p class="mb-1 text-muted">{{ application.reference2_position }}</p>
                <p class="mb-0">{{ application.reference2_phone }}</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
