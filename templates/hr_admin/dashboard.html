{% extends 'hr_admin/base.html' %}
{% load static %}

{% block hr_content %}
<!-- Header Row -->
<div class="row" style="margin-bottom:8px;align-items:center;">
  <div class="col s12 m8">
    <h5 style="color:#003087;font-weight:700;margin:0;">
      <i class="material-icons" style="vertical-align:middle;margin-right:8px;">dashboard</i>
      HR Administration Dashboard
    </h5>
    <p style="color:#666;margin:4px 0 0;">Papua New Guinea Civil Service Recruitment Portal</p>
  </div>
  <div class="col s12 m4" style="text-align:right;">
    <a href="{% url 'hr_admin:vacancy_create' %}" class="btn" style="background:#003087;">
      <i class="material-icons left">add</i>Post New Vacancy
    </a>
  </div>
</div>

<!-- 4 Main Stat Cards -->
<div class="row">
  <div class="col s6 m3">
    <div class="stat-card" style="background:#003087;color:#fff;border-radius:8px;padding:20px;text-align:center;box-shadow:0 2px 8px rgba(0,48,135,0.3);">
      <div style="font-size:2.5rem;font-weight:700;">{{ total_applications|default:"0" }}</div>
      <div style="font-size:13px;opacity:0.9;margin-top:4px;">
        <i class="material-icons tiny">description</i> Total Applications
      </div>
    </div>
  </div>
  <div class="col s6 m3">
    <div class="stat-card" style="background:#1565c0;color:#fff;border-radius:8px;padding:20px;text-align:center;box-shadow:0 2px 8px rgba(21,101,192,0.3);">
      <div style="font-size:2.5rem;font-weight:700;">{{ today_applications|default:"0" }}</div>
      <div style="font-size:13px;opacity:0.9;margin-top:4px;">
        <i class="material-icons tiny">today</i> Today
      </div>
    </div>
  </div>
  <div class="col s6 m3">
    <div class="stat-card" style="background:#2e7d32;color:#fff;border-radius:8px;padding:20px;text-align:center;box-shadow:0 2px 8px rgba(46,125,50,0.3);">
      <div style="font-size:2.5rem;font-weight:700;">{{ shortlisted_count|default:"0" }}</div>
      <div style="font-size:13px;opacity:0.9;margin-top:4px;">
        <i class="material-icons tiny">star</i> Shortlisted
      </div>
    </div>
  </div>
  <div class="col s6 m3">
    <div class="stat-card" style="background:#e65100;color:#fff;border-radius:8px;padding:20px;text-align:center;box-shadow:0 2px 8px rgba(230,81,0,0.3);">
      <div style="font-size:2.5rem;font-weight:700;">{{ interviews_today|default:"0" }}</div>
      <div style="font-size:13px;opacity:0.9;margin-top:4px;">
        <i class="material-icons tiny">event</i> Interviews Today
      </div>
    </div>
  </div>
</div>

<!-- 4 Smaller Stat Chips -->
<div class="row" style="margin-bottom:8px;">
  <div class="col s12">
    <span class="chip" style="background:#e3eaf6;color:#003087;font-weight:600;margin-right:8px;">
      <i class="material-icons tiny">work_outline</i>&nbsp; Open Vacancies: <strong>{{ open_vacancies|default:"0" }}</strong>
    </span>
    <span class="chip" style="background:#fff3e0;color:#e65100;font-weight:600;margin-right:8px;">
      <i class="material-icons tiny">hourglass_empty</i>&nbsp; Under Review: <strong>{{ under_review_count|default:"0" }}</strong>
    </span>
    <span class="chip" style="background:#e8f5e9;color:#2e7d32;font-weight:600;margin-right:8px;">
      <i class="material-icons tiny">check_circle</i>&nbsp; Selected: <strong>{{ selected_count|default:"0" }}</strong>
    </span>
    <span class="chip" style="background:#ede7f6;color:#4527a0;font-weight:600;">
      <i class="material-icons tiny">folder</i>&nbsp; Total Vacancies: <strong>{{ total_vacancies|default:"0" }}</strong>
    </span>
  </div>
</div>

<!-- Charts Row -->
<div class="row">
  <div class="col s12 m8">
    <div class="card" style="border-radius:8px;">
      <div class="card-content">
        <span class="card-title" style="font-size:16px;color:#003087;font-weight:600;">
          <i class="material-icons tiny">bar_chart</i> Applications by Province
        </span>
        <canvas id="provinceChart" height="120"></canvas>
      </div>
    </div>
  </div>
  <div class="col s12 m4">
    <div class="card" style="border-radius:8px;">
      <div class="card-content">
        <span class="card-title" style="font-size:16px;color:#003087;font-weight:600;">
          <i class="material-icons tiny">donut_large</i> Status Distribution
        </span>
        <canvas id="statusChart" height="200"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Open Vacancies + Recent Applications Row -->
<div class="row">
  <div class="col s12 m5">
    <div class="card" style="border-radius:8px;">
      <div class="card-content" style="padding-bottom:0;">
        <span class="card-title" style="font-size:16px;color:#003087;font-weight:600;">
          <i class="material-icons tiny">work</i> Open Vacancies
        </span>
      </div>
      {% if open_vacancy_list %}
        <ul class="collection" style="margin:0;border:none;">
          {% for vacancy in open_vacancy_list %}
            <li class="collection-item" style="padding:10px 20px;">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                  <div style="font-weight:600;font-size:13px;color:#003087;">{{ vacancy.title }}</div>
                  <div style="font-size:11px;color:#888;">{{ vacancy.department }} &bull; Closes {{ vacancy.close_date }}</div>
                </div>
                <span class="chip" style="background:#e3eaf6;color:#003087;font-size:11px;min-width:32px;justify-content:center;">
                  {{ vacancy.application_count|default:"0" }}
                </span>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="empty-state" style="padding:24px;text-align:center;color:#aaa;">
          <i class="material-icons" style="font-size:40px;">work_off</i>
          <p>No open vacancies</p>
        </div>
      {% endif %}
    </div>
  </div>

  <div class="col s12 m7">
    <div class="card" style="border-radius:8px;">
      <div class="card-content" style="padding-bottom:0;">
        <span class="card-title" style="font-size:16px;color:#003087;font-weight:600;">
          <i class="material-icons tiny">history</i> Recent Applications
        </span>
      </div>
      {% if recent_applications %}
        <div class="responsive-table">
          <table class="striped hoverable" style="font-size:13px;">
            <thead style="background:#f5f6fa;">
              <tr>
                <th style="color:#003087;">Name</th>
                <th style="color:#003087;">Position</th>
                <th style="color:#003087;">Score</th>
                <th style="color:#003087;">Status</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for app in recent_applications %}
                <tr>
                  <td style="font-weight:600;">{{ app.full_name }}</td>
                  <td style="max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
                    {{ app.vacancy.title }}
                  </td>
                  <td>
                    {% if app.score is not None %}
                      {% if app.score >= 70 %}
                        <span class="chip score-hi" style="font-size:11px;">{{ app.score }}</span>
                      {% elif app.score >= 50 %}
                        <span class="chip score-md" style="font-size:11px;">{{ app.score }}</span>
                      {% else %}
                        <span class="chip score-lo" style="font-size:11px;">{{ app.score }}</span>
                      {% endif %}
                    {% else %}
                      <span class="chip" style="font-size:11px;background:#eee;color:#999;">N/A</span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="chip s-{{ app.status }}" style="font-size:11px;">{{ app.get_status_display }}</span>
                  </td>
                  <td>
                    <a href="{% url 'hr_admin:application_detail' app.pk %}" class="btn-small" style="background:#003087;">
                      <i class="material-icons" style="font-size:14px;">visibility</i>
                    </a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="empty-state" style="padding:24px;text-align:center;color:#aaa;">
          <i class="material-icons" style="font-size:40px;">inbox</i>
          <p>No recent applications</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  const provinceLabels = {{ province_labels|safe }};
  const provinceCounts = {{ province_counts|safe }};
  const statusLabels = {{ status_labels|safe }};
  const statusCounts = {{ status_counts|safe }};

  // Province Bar Chart
  new Chart(document.getElementById('provinceChart'), {
    type: 'bar',
    data: {
      labels: provinceLabels,
      datasets: [{
        label: 'Applications',
        data: provinceCounts,
        backgroundColor: '#003087',
        borderRadius: 4,
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
    }
  });

  // Status Doughnut Chart
  new Chart(document.getElementById('statusChart'), {
    type: 'doughnut',
    data: {
      labels: statusLabels,
      datasets: [{
        data: statusCounts,
        backgroundColor: ['#003087','#1565c0','#2e7d32','#f9a825','#c62828','#6a1b9a','#00838f'],
        borderWidth: 2,
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'bottom', labels: { font: { size: 11 } } } }
    }
  });
</script>
{% endblock %}
