{% extends 'base.html' %}
{% block title %}Apply — {{ vacancy.title }}{% endblock %}
{% block content %}

<!-- Breadcrumb -->
<div style="background:#fff; border-bottom:1px solid #e0e0e0; padding:10px 0;">
    <div class="container">
        <span class="breadcrumb" style="color:#9e9e9e; font-size:0.9rem;">
            <a href="{% url 'recruitment:job_list' %}" style="color:#616161;">Vacancies</a>
        </span>
        <span class="breadcrumb" style="color:#9e9e9e; font-size:0.9rem;">
            <a href="{% url 'recruitment:job_detail' vacancy.pk %}" style="color:#616161;">{{ vacancy.title|truncatechars:30 }}</a>
        </span>
        <span class="breadcrumb" style="color:#003087; font-size:0.9rem; font-weight:600;">Apply</span>
    </div>
</div>

<div class="container" style="margin-top:24px; margin-bottom:60px;">
    <div class="row">
        <!-- Application Form -->
        <div class="col s12 l8">
            <div class="card z-depth-1" style="border-radius:8px; overflow:hidden;">
                <div class="card-header">
                    <h5><i class="material-icons" style="vertical-align:middle; margin-right:8px;">send</i>Application Form</h5>
                    <small>{{ vacancy.title }} — Ref: {{ vacancy.reference_number }}</small>
                </div>
                <div class="card-content" style="padding:24px 28px;">
                    <form method="post" enctype="multipart/form-data" id="applyForm">
                        {% csrf_token %}

                        <!-- 1. Personal Information -->
                        <div class="section-divider">
                            <i class="material-icons" style="font-size:1rem;">person</i>
                            1. Personal Information
                        </div>
                        <div class="row" style="margin-bottom:0;">
                            <div class="input-field col s12 m6">
                                <input id="fn" type="text" name="first_name" value="{{ form.first_name.value|default:'' }}" required>
                                <label for="fn" {% if form.first_name.value %}class="active"{% endif %}>First Name *</label>
                            </div>
                            <div class="input-field col s12 m6">
                                <input id="ln" type="text" name="last_name" value="{{ form.last_name.value|default:'' }}" required>
                                <label for="ln" {% if form.last_name.value %}class="active"{% endif %}>Last Name *</label>
                            </div>
                        </div>
                        <div class="row" style="margin-bottom:0;">
                            <div class="input-field col s12 m4">
                                <input id="dob" type="date" name="date_of_birth" value="{{ form.date_of_birth.value|date:'Y-m-d'|default:'' }}" required>
                                <label for="dob" class="active">Date of Birth *</label>
                            </div>
                            <div class="input-field col s12 m4">
                                <select name="gender" required>
                                    <option value="" disabled {% if not form.gender.value %}selected{% endif %}>Select</option>
                                    <option value="Male" {% if form.gender.value == 'Male' %}selected{% endif %}>Male</option>
                                    <option value="Female" {% if form.gender.value == 'Female' %}selected{% endif %}>Female</option>
                                    <option value="Other" {% if form.gender.value == 'Other' %}selected{% endif %}>Other</option>
                                </select>
                                <label>Gender *</label>
                            </div>
                            <div class="input-field col s12 m4">
                                <input id="nat" type="text" name="nationality" value="{{ form.nationality.value|default:'Papua New Guinean' }}" required>
                                <label for="nat" class="active">Nationality *</label>
                            </div>
                        </div>
                        <div class="row" style="margin-bottom:0;">
                            <div class="input-field col s12 m6">
                                <select name="province" required>
                                    <option value="" disabled {% if not form.province.value %}selected{% endif %}>Select Province</option>
                                    {% for val, label in form.province.field.choices %}
                                        {% if val %}<option value="{{ val }}" {% if form.province.value == val %}selected{% endif %}>{{ label }}</option>{% endif %}
                                    {% endfor %}
                                </select>
                                <label>Province of Origin *</label>
                            </div>
                            <div class="input-field col s12 m6">
                                <input id="ph" type="text" name="phone" value="{{ form.phone.value|default:'' }}" required placeholder="+675 XXXX XXXX">
                                <label for="ph" {% if form.phone.value %}class="active"{% endif %}>Phone Number *</label>
                            </div>
                        </div>
                        <div class="input-field">
                            <input id="em" type="email" name="email" value="{{ form.email.value|default:'' }}" required>
                            <label for="em" {% if form.email.value %}class="active"{% endif %}>Email Address *</label>
                        </div>
                        <div class="input-field">
                            <textarea id="addr" name="address" class="materialize-textarea" required>{{ form.address.value|default:'' }}</textarea>
                            <label for="addr" {% if form.address.value %}class="active"{% endif %}>Residential Address *</label>
                        </div>

                        <!-- 2. Education -->
                        <div class="section-divider" style="margin-top:20px;">
                            <i class="material-icons" style="font-size:1rem;">school</i>
                            2. Education &amp; Qualifications
                        </div>
                        <div class="row" style="margin-bottom:0;">
                            <div class="input-field col s12 m6">
                                <select name="highest_qualification" required>
                                    <option value="" disabled {% if not form.highest_qualification.value %}selected{% endif %}>Select</option>
                                    {% for val, label in form.highest_qualification.field.choices %}
                                        {% if val %}<option value="{{ val }}" {% if form.highest_qualification.value == val %}selected{% endif %}>{{ label }}</option>{% endif %}
                                    {% endfor %}
                                </select>
                                <label>Highest Qualification *</label>
                            </div>
                            <div class="input-field col s12 m6">
                                <input id="inst" type="text" name="institution" value="{{ form.institution.value|default:'' }}" required>
                                <label for="inst" {% if form.institution.value %}class="active"{% endif %}>Institution / School *</label>
                            </div>
                        </div>
                        <div class="row" style="margin-bottom:0;">
                            <div class="input-field col s12 m4">
                                <input id="yr" type="number" name="year_completed" value="{{ form.year_completed.value|default:'' }}" min="1990" max="2026" required>
                                <label for="yr" {% if form.year_completed.value %}class="active"{% endif %}>Year Completed *</label>
                            </div>
                            <div class="input-field col s12 m8">
                                <input id="gr" type="text" name="grade_result" value="{{ form.grade_result.value|default:'' }}" required placeholder="e.g. Distinction, GPA 3.5/4.0, Credit">
                                <label for="gr" {% if form.grade_result.value %}class="active"{% endif %}>Grade / GPA / Result *</label>
                            </div>
                        </div>

                        <!-- 3. Work Experience -->
                        <div class="section-divider" style="margin-top:20px;">
                            <i class="material-icons" style="font-size:1rem;">work</i>
                            3. Work Experience
                        </div>
                        <div class="row" style="margin-bottom:0;">
                            <div class="input-field col s12 m3">
                                <input id="exp" type="number" name="years_experience" value="{{ form.years_experience.value|default:'0' }}" min="0" max="50" required>
                                <label for="exp" class="active">Years Exp. *</label>
                            </div>
                            <div class="input-field col s12 m5">
                                <input id="emp" type="text" name="current_employer" value="{{ form.current_employer.value|default:'' }}">
                                <label for="emp" {% if form.current_employer.value %}class="active"{% endif %}>Current Employer</label>
                            </div>
                            <div class="input-field col s12 m4">
                                <input id="pos" type="text" name="current_position" value="{{ form.current_position.value|default:'' }}">
                                <label for="pos" {% if form.current_position.value %}class="active"{% endif %}>Current Position</label>
                            </div>
                        </div>
                        <div class="input-field">
                            <textarea id="wh" name="work_history" class="materialize-textarea" placeholder="Briefly describe your previous work experience...">{{ form.work_history.value|default:'' }}</textarea>
                            <label for="wh" {% if form.work_history.value %}class="active"{% endif %}>Work History Summary</label>
                        </div>

                        <!-- 4. References -->
                        <div class="section-divider" style="margin-top:20px;">
                            <i class="material-icons" style="font-size:1rem;">people</i>
                            4. References
                        </div>
                        <p style="font-size:0.82rem; color:#757575; margin:-8px 0 12px; font-weight:500;">Reference 1 (Required)</p>
                        <div class="row" style="margin-bottom:0;">
                            <div class="input-field col s12 m4">
                                <input id="r1n" type="text" name="reference1_name" value="{{ form.reference1_name.value|default:'' }}" required>
                                <label for="r1n" {% if form.reference1_name.value %}class="active"{% endif %}>Full Name *</label>
                            </div>
                            <div class="input-field col s12 m4">
                                <input id="r1p" type="text" name="reference1_position" value="{{ form.reference1_position.value|default:'' }}" required>
                                <label for="r1p" {% if form.reference1_position.value %}class="active"{% endif %}>Position / Title *</label>
                            </div>
                            <div class="input-field col s12 m4">
                                <input id="r1ph" type="text" name="reference1_phone" value="{{ form.reference1_phone.value|default:'' }}" required>
                                <label for="r1ph" {% if form.reference1_phone.value %}class="active"{% endif %}>Phone *</label>
                            </div>
                        </div>
                        <p style="font-size:0.82rem; color:#757575; margin:4px 0 12px; font-weight:500;">Reference 2 (Optional)</p>
                        <div class="row" style="margin-bottom:0;">
                            <div class="input-field col s12 m4">
                                <input id="r2n" type="text" name="reference2_name" value="{{ form.reference2_name.value|default:'' }}">
                                <label for="r2n" {% if form.reference2_name.value %}class="active"{% endif %}>Full Name</label>
                            </div>
                            <div class="input-field col s12 m4">
                                <input id="r2p" type="text" name="reference2_position" value="{{ form.reference2_position.value|default:'' }}">
                                <label for="r2p" {% if form.reference2_position.value %}class="active"{% endif %}>Position / Title</label>
                            </div>
                            <div class="input-field col s12 m4">
                                <input id="r2ph" type="text" name="reference2_phone" value="{{ form.reference2_phone.value|default:'' }}">
                                <label for="r2ph" {% if form.reference2_phone.value %}class="active"{% endif %}>Phone</label>
                            </div>
                        </div>

                        <!-- 5. Cover Letter -->
                        <div class="section-divider" style="margin-top:20px;">
                            <i class="material-icons" style="font-size:1rem;">description</i>
                            5. Cover Letter
                        </div>
                        <div class="input-field">
                            <textarea id="cl" name="cover_letter" class="materialize-textarea" style="min-height:120px;" placeholder="Write a brief cover letter explaining why you are applying...">{{ form.cover_letter.value|default:'' }}</textarea>
                            <label for="cl" {% if form.cover_letter.value %}class="active"{% endif %}>Cover Letter</label>
                        </div>

                        <!-- 6. Document Uploads -->
                        <div class="section-divider" style="margin-top:20px;">
                            <i class="material-icons" style="font-size:1rem;">attach_file</i>
                            6. Supporting Documents
                        </div>
                        <div id="docFields">
                            <div class="doc-row row" style="margin-bottom:8px; align-items:center;">
                                <div class="input-field col s12 m5" style="margin-top:0;">
                                    <select name="doc_types">
                                        <option value="cv">CV</option>
                                        <option value="national_id">National ID</option>
                                        <option value="academic_transcript">Academic Transcript</option>
                                        <option value="qualification">Qualification/Certificate</option>
                                        <option value="reference_letter">Reference Letter</option>
                                        <option value="other">Other</option>
                                    </select>
                                    <label>Document Type</label>
                                </div>
                                <div class="file-field input-field col s12 m7">
                                    <div class="btn btn-small" style="background:#546e7a;">
                                        <span>Browse</span>
                                        <input type="file" name="documents">
                                    </div>
                                    <div class="file-path-wrapper">
                                        <input class="file-path validate" type="text" placeholder="Choose file">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <a class="btn-flat waves-effect" style="color:#546e7a; font-size:0.88rem;" onclick="addDocRow()">
                            <i class="material-icons left">add</i>Add Another Document
                        </a>
                        <p style="font-size:0.78rem; color:#9e9e9e; margin:8px 0 0;">
                            <i class="material-icons" style="font-size:0.85rem; vertical-align:middle;">info_outline</i>
                            Accepted formats: PDF, JPG, PNG (max 10MB each)
                        </p>

                        <!-- Submit -->
                        <div style="margin-top:28px; display:flex; gap:12px;">
                            <button type="submit" class="btn waves-effect waves-light btn-large" style="background:#003087; font-weight:700; border-radius:4px; flex:1;">
                                <i class="material-icons left">send</i>Submit Application
                            </button>
                            <a href="{% url 'recruitment:job_detail' vacancy.pk %}" class="btn btn-large btn-flat waves-effect" style="color:#616161; border:1px solid #e0e0e0;">
                                Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col s12 l4">
            <div class="card z-depth-1" style="border-radius:8px; position:sticky; top:80px;">
                <div style="background:#003087; padding:16px 20px; border-radius:8px 8px 0 0;">
                    <h6 style="color:#fff; font-weight:700; margin:0;">{{ vacancy.title }}</h6>
                    <p style="color:rgba(255,255,255,0.65); font-size:0.82rem; margin:4px 0 0;">{{ vacancy.department }}</p>
                </div>
                <div class="card-content" style="padding:16px 20px;">
                    <table style="font-size:0.85rem; width:100%;">
                        <tr>
                            <td style="color:#9e9e9e; padding:5px 0; font-weight:600;">Category</td>
                            <td style="padding:5px 0;">{{ vacancy.get_category_display }}</td>
                        </tr>
                        <tr>
                            <td style="color:#9e9e9e; padding:5px 0; font-weight:600;">Province</td>
                            <td style="padding:5px 0;">{{ vacancy.province }}</td>
                        </tr>
                        <tr>
                            <td style="color:#9e9e9e; padding:5px 0; font-weight:600;">Min. Qualification</td>
                            <td style="padding:5px 0;">{{ vacancy.get_qualification_level_display }}</td>
                        </tr>
                        <tr>
                            <td style="color:#9e9e9e; padding:5px 0; font-weight:600;">Positions</td>
                            <td style="padding:5px 0;"><span class="chip" style="background:#e8f5e9; color:#2e7d32;">{{ vacancy.positions_available }}</span></td>
                        </tr>
                        <tr>
                            <td style="color:#9e9e9e; padding:5px 0; font-weight:600;">Age Range</td>
                            <td style="padding:5px 0;">{{ vacancy.min_age }}–{{ vacancy.max_age }} years</td>
                        </tr>
                        {% if vacancy.salary_range %}
                        <tr>
                            <td style="color:#9e9e9e; padding:5px 0; font-weight:600;">Salary</td>
                            <td style="padding:5px 0; color:#2e7d32; font-weight:600;">{{ vacancy.salary_range }}</td>
                        </tr>
                        {% endif %}
                        <tr>
                            <td style="color:#9e9e9e; padding:5px 0; font-weight:600;">Closes</td>
                            <td style="padding:5px 0; color:#c62828; font-weight:700;">{{ vacancy.close_date|date:"d M Y" }}</td>
                        </tr>
                    </table>

                    <div style="margin-top:16px; padding-top:16px; border-top:1px solid #f0f0f0;">
                        <p style="font-size:0.72rem; color:#9e9e9e; font-weight:700; text-transform:uppercase; letter-spacing:0.8px; margin-bottom:8px;">AI Scoring Criteria</p>
                        {% for label, pct in scoring_criteria %}
                        <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:4px;">
                            <span style="color:#616161;">{{ label }}</span>
                            <span style="color:#003087; font-weight:700;">{{ pct }}%</span>
                        </div>
                        {% empty %}
                        <div style="font-size:0.8rem; color:#757575; line-height:1.8;">
                            <div style="display:flex; justify-content:space-between;"><span>Education Level</span><span style="color:#003087; font-weight:700;">30%</span></div>
                            <div style="display:flex; justify-content:space-between;"><span>Academic Grade</span><span style="color:#003087; font-weight:700;">25%</span></div>
                            <div style="display:flex; justify-content:space-between;"><span>Work Experience</span><span style="color:#003087; font-weight:700;">20%</span></div>
                            <div style="display:flex; justify-content:space-between;"><span>Provincial Origin</span><span style="color:#003087; font-weight:700;">10%</span></div>
                            <div style="display:flex; justify-content:space-between;"><span>Form Completeness</span><span style="color:#003087; font-weight:700;">15%</span></div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}
{% block extra_js %}
<script>
function addDocRow() {
    const template = `
    <div class="doc-row row" style="margin-bottom:8px; align-items:center;">
        <div class="input-field col s12 m5" style="margin-top:0;">
            <select name="doc_types">
                <option value="cv">CV</option>
                <option value="national_id">National ID</option>
                <option value="academic_transcript">Academic Transcript</option>
                <option value="qualification">Qualification/Certificate</option>
                <option value="reference_letter">Reference Letter</option>
                <option value="other">Other</option>
            </select>
            <label>Document Type</label>
        </div>
        <div class="file-field input-field col s12 m6">
            <div class="btn btn-small" style="background:#546e7a;">
                <span>Browse</span>
                <input type="file" name="documents">
            </div>
            <div class="file-path-wrapper">
                <input class="file-path validate" type="text" placeholder="Choose file">
            </div>
        </div>
        <div class="col s12 m1" style="margin-top:0;">
            <a class="btn-flat waves-effect red-text" onclick="this.closest('.doc-row').remove()">
                <i class="material-icons">close</i>
            </a>
        </div>
    </div>`;
    const div = document.createElement('div');
    div.innerHTML = template;
    document.getElementById('docFields').appendChild(div.firstElementChild);
    M.FormSelect.init(document.querySelectorAll('#docFields select'));
}
</script>
{% endblock %}
